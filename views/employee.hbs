<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Список пользователей</title>
    <script src="../js/jquery-3.3.1.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/styles.css">
    <link href="../css/registration.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="employee_form">


<div class="form_box" id="content1">

    <label for="computer_name">Имя компьютера:</label>
    <input type="text" id="computer_name" required />

    <label for="processor">Процессор</label>
    <input type="text" id="processor" required />

    <label for="video">Видеокарта:</label>
    <input type="text" id="video" required />

    <label for="disk">Жёсткий диск</label>
    <input type="password" id="disk" required />

    <label for="ram">Оперативная память:</label>
    <input type="text" id="ram" required />

    <label for="price">Цена:</label>
    <input type="text" id="price" required />

    <label>Производитель:</label>
    <div class="content_employee" >
        <div class="select-wrapper">
            <select name='manufactures' id='manufactures'>
            </select>
            <div class="select-arrow-1"></div>
        </div>
    </div>
    <input type="text" id="manufacture" required disabled/>

    <button type="submit" id="button1" class="btn_submit">Добавить компьютер</button>

</div>
<div class="form_box" id="content2">
        <label for="monitor_name">Название монитора:</label>
        <input type="text" id="monitor_name" required />

        <button type="submit" id="button2" class="btn_submit">Добавить монитор</button>

</div>
<div class="form_box" id="content3">

        <label for="name_surname">Имя и Фамилия:</label>
        <input type="text" id="name_surname" required />

        <label for="chief">Начальник</label>
    <div class="content_employee" >
        <div class="select-wrapper">
            <select name='employees' id='employees'>

            </select>
            <div class="select-arrow-1"></div>
        </div>
    </div>
        <input type="text" id="chief" required disabled/>

        <button type="submit" id="button3" class="btn_submit">Добавить работника</button>
</div>

</div>
<div id="mask"></div>
<div class="small_message" id="add"><h3 id="text"></h3></div>


<script>
    let employeesSelect = employees;
    let manufacturesSelect = manufactures;
    let chiefId=0;
    let manufactureId=0;
    // Получение одного пользователя
    function GetComputer(computer_name,processor,video,disk,ram,price) {
        $.ajax({
            url: "/api/createComp/?"+computer_name,
            type: "GET",
            contentType: "application/json",
            success: function (exist) {
                console.log(exist);
                if(exist){
                    showMessage("existComputer","Такой компьютер уже есть");
                }
                else {CreateComputer(computer_name,processor,video,disk,ram,price)}
            }
        });
    }
    function GetMonitor(name) {
        $.ajax({
            url: "/api/createMonitor/?"+name,
            type: "GET",
            contentType: "application/json",
            success: function (exist) {
                console.log(exist);
                if(exist){
                    showMessage("existComputer","Такой монитор уже есть");
                }
                else {CreateMonitor(name)}
            }
        });
    }
    // Добавление пользователя
    function CreateComputer(computer_name,processor,video,disk,ram,price) {
        $.ajax({
            url: "api/computers",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                name: computer_name,
                processor: processor,
                video: video,
                disk:disk,
                ram:ram,
                price:price,
                manufactureId:manufactureId
            }),
            success: function () {
                showMessage("add","Компьютер добавлен");
            }
        })
    }
    function CreateMonitor(name) {
        $.ajax({
            url: "api/monitors",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                name: name
            }),
            success: function () {
                showMessage("add","Монитор добавлен");
            }
        })
    }
    function CreateEmployee(info) {

        $.ajax({
            url: "api/employees",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                name_surname: info,
                chief_id:chiefId
            }),
            success: function () {
                showMessage("add","Работник добавлен");
            }
        })
    }
    function showMessage(id,message) {
        document.querySelector("#text").innerHTML=message;
        $("#mask").fadeIn(500,function () {
            $("#add").fadeIn(1000,function () {
                $("#add").fadeOut(3000,function () {
                    $("#mask").fadeOut(250);
                });

            })
        });


    }
    //отправка формы
    $("#button1").click(function (e) {
        $('#content1 input[required]').addClass('req');
        e.preventDefault();
        let computer_name = document.querySelector("#computer_name").value;
        let processor = document.querySelector("#processor").value;
        let video = document.querySelector("#video").value;
        let disk = document.querySelector("#disk").value;
        let ram = document.querySelector("#ram").value;
        let price = document.querySelector("#price").value;
        if(computer_name&&processor&&video&&disk&&ram&&price&&manufactureId){
            $('#content1 input[required]').removeClass('req');
            document.querySelector("#computer_name").value="";
            document.querySelector("#processor").value="";
            document.querySelector("#video").value="";
            document.querySelector("#disk").value="";
            document.querySelector("#ram").value="";
            document.querySelector("#price").value="";
            GetComputer(computer_name, processor,video,disk,ram,price);
        }
    });
    $("#button2").click(function (e) {
        $('#content2 input[required]').addClass('req');
        let name = document.querySelector("#monitor_name").value;
        if(name){
            $('#content2 input[required]').removeClass('req');
            document.querySelector("#monitor_name").value="";
            GetMonitor(name);
        }
    });
    $("#button3").click(function (e) {
        $('#content3 input[required]').addClass('req');
        e.preventDefault();
        let info = document.querySelector("#name_surname").value;
        if(info&&chiefId){
            $('#content3 input[required]').removeClass('req');
            $('#content3 input[required]').value="";
            CreateEmployee(info);
        }
    });
    function GetEmployees() {
        $.ajax({
            url: "/api/employees",
            type: "GET",
            contentType: "application/json",
            success: function (employees) {
                var rows = "";
                $.each(employees, function (index, user) {
                    // добавляем полученные элементы в таблицу
                    rows += options(user);
                });
                $("#employees").append(rows);
            }
        });
    }
    function GetManufactures() {
        $.ajax({
            url: "/api/manufactures",
            type: "GET",
            contentType: "application/json",
            success: function (employees) {
                var rows = "";
                $.each(employees, function (index, user) {
                    // добавляем полученные элементы в таблицу
                    rows += options(user);
                });
                $("#manufactures").append(rows);
            }
        });
    }
    let options = function (employee) {
        let data="";
        data+="<option value='" + employee[0] + "'>" + employee[1] + "</option>";
        return data;
    };
    function chiefOption(){
        let selection = document.getElementById("chief");
        let selectedOption = employeesSelect.options[employeesSelect.selectedIndex];
        selection.value = selectedOption.text;
        chiefId=selectedOption.value;
    }
    function manufactureOption(){
        let selection = document.getElementById("manufacture");
        let selectedOption = manufacturesSelect.options[manufacturesSelect.selectedIndex];
        selection.value = selectedOption.text;
        manufactureId=selectedOption.value;
    }
    employeesSelect.addEventListener("change", chiefOption);
    manufacturesSelect.addEventListener("change", manufactureOption);
    GetManufactures();
    GetEmployees();
</script>
</body>
</html>